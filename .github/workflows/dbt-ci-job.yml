name: dbt CI 

on:
  workflow_call:

jobs:
  dbt-build:
    runs-on: ubuntu-latest
    
    # Set DBT_PROFILES_DIR once for all steps
    env:
      DBT_PROFILES_DIR: "."
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for state comparison
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dbt and dependencies
      run: |
        python -m pip install --upgrade pip
        pip install "urllib3<2.0"
        pip install "dbt-core==1.10.10" dbt-duckdb duckdb
        
    - name: Run dbt deps
      run: dbt deps

# ---- Restore previous state (cache) ----
# Because we are in contained CI environment not getting any artifacts from prod to compare to -- we're going to use cache. 
    - name: Restore previous state cache
      id: state-restore
      uses: actions/cache@v4
      with:
        path: previous-state
        key: dbt-state-${{ github.ref_name }}
        restore-keys: |
          dbt-state-${{ github.ref_name }}-  
          dbt-state-${{ github.base_ref || 'main' }}-
          dbt-state-
        
    - name: dbt build (state:modified if available)
      shell: bash
      run: |
        if [ -f previous-state/manifest.json ]; then
          echo "ðŸ”„ Using previous state: building state:modified+"
          dbt build --state previous-state --select state:modified+
        else
          echo "ðŸš€ Cold start: full build"
          dbt build
        fi
      
    - name: Generate documentation
      run: dbt docs generate
        
    - name: Upload pipeline artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dbt-pipeline-results
        path: |
          workshop.duckdb
          target/
          logs/
        retention-days: 7
        
    - name: Upload state artifacts (for next run)
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: dbt-state-artifacts
        path: target/
        retention-days: 30
        
    # Prepare & save fresh state for next run
    - name: Prepare state bundle
      if: always()
      run: |
        rm -rf previous-state
        mkdir -p previous-state
        cp -v target/manifest.json target/run_results.json target/catalog.json previous-state/ || true

    - name: Save state cache
      if: always()
      uses: actions/cache/save@v4
      with:
        path: previous-state
        key: dbt-state-${{ github.ref_name }}-${{ github.run_id }}


    - name: Display pipeline summary
      if: always()
      run: |
        echo "ðŸ“Š dbt Pipeline Summary:"
        echo "================================"
        if [ -f "workshop.duckdb" ]; then
          echo "âœ… Database created: workshop.duckdb"
          echo "ðŸ“‹ Tables created:"
          duckdb workshop.duckdb "SHOW TABLES;" || echo "Could not list tables"
        else
          echo "âŒ Database not created"
        fi